# .github/workflows/run-single-test.yml
name: Run single test and upload report

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  run-test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest on tests/test_example.py
        run: |
          pytest tests/test_example.py \
            --json-report \
            --json-report-file=report-single.json \
            -q

      - name: Create upload URL for Artifact
        id: create_artifact
        run: |
          # 1) Create a new artifact container (max 5 GiB, expires in 1 week)
          RESPONSE=$(curl \
            -sSL \
            -X POST https://api.github.com/repos/${{ github.repository }}/actions/artifacts \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{ 
                  "name": "single-test-report", 
                  "path": "report-single.json", 
                  "expire_in_days": 7
                }')

          # 2) Extract the `upload_url` from the JSON response
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r .upload_url)
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Upload report-single.json
        run: |
          # The upload_url returned by the previous step looks like:
          # https://uploads.github.com/repos/OWNER/REPO/actions/artifacts/ARTIFACT_ID/zip
          # We need to append ?name=<filename> to actually upload a single file.
          URL="${{ steps.create_artifact.outputs.upload_url }}?name=report-single.json"

          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/zip" \
            --data-binary @report-single.json \
            "$URL"
      